<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../ rel=prev><link href=../rpi-usg-4g-failover/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.12"><title>Proxmox - Ramblurr's Notes</title><link rel=stylesheet href=../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CIMB+Plex+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"IMB Plex Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#proxmox class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Ramblurr's Notes" class="md-header__button md-logo" aria-label="Ramblurr's Notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Ramblurr's Notes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Proxmox </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Ramblurr's Notes" class="md-nav__button md-logo" aria-label="Ramblurr's Notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Ramblurr's Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Ramblurr's Notes </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../ >HomeOps</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> HomeOps </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Proxmox <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Proxmox </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#install-checklist class=md-nav__link> Install checklist </a> </li> <li class=md-nav__item> <a href=#post-install-checklist class=md-nav__link> Post-install checklist </a> </li> <li class=md-nav__item> <a href=#configuring-cluster class=md-nav__link> Configuring Cluster </a> </li> <li class=md-nav__item> <a href=#replicating-vms class=md-nav__link> Replicating VMs </a> </li> <li class=md-nav__item> <a href=#replacing-a-zfs-boot-disk class=md-nav__link> Replacing a ZFS Boot Disk </a> </li> <li class=md-nav__item> <a href=#tailscale-in-a-container class=md-nav__link> Tailscale in a container: </a> </li> <li class=md-nav__item> <a href=#setting-up-nfs-share class=md-nav__link> Setting up NFS Share </a> </li> <li class=md-nav__item> <a href=#multiple-vlans-with-single-nic class=md-nav__link> Multiple VLANs with Single NIC </a> </li> <li class=md-nav__item> <a href=#installing-proxmox-as-a-vm-in-freenas class=md-nav__link> Installing Proxmox as a VM in FreeNAS </a> </li> <li class=md-nav__item> <a href=#import-a-cloudimg class=md-nav__link> Import a cloudimg </a> </li> <li class=md-nav__item> <a href=#custom-cloud-init-userdata class=md-nav__link> Custom cloud init userdata </a> </li> <li class=md-nav__item> <a href=#remove-all-containers class=md-nav__link> Remove all containers </a> </li> <li class=md-nav__item> <a href=#deploy-fedora-coreos-template class=md-nav__link> Deploy fedora coreos template </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../rpi-usg-4g-failover/ class=md-nav__link> Unifi USG LTE Failover </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../RaspberryPi/ class=md-nav__link> RaspberryPi </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#install-checklist class=md-nav__link> Install checklist </a> </li> <li class=md-nav__item> <a href=#post-install-checklist class=md-nav__link> Post-install checklist </a> </li> <li class=md-nav__item> <a href=#configuring-cluster class=md-nav__link> Configuring Cluster </a> </li> <li class=md-nav__item> <a href=#replicating-vms class=md-nav__link> Replicating VMs </a> </li> <li class=md-nav__item> <a href=#replacing-a-zfs-boot-disk class=md-nav__link> Replacing a ZFS Boot Disk </a> </li> <li class=md-nav__item> <a href=#tailscale-in-a-container class=md-nav__link> Tailscale in a container: </a> </li> <li class=md-nav__item> <a href=#setting-up-nfs-share class=md-nav__link> Setting up NFS Share </a> </li> <li class=md-nav__item> <a href=#multiple-vlans-with-single-nic class=md-nav__link> Multiple VLANs with Single NIC </a> </li> <li class=md-nav__item> <a href=#installing-proxmox-as-a-vm-in-freenas class=md-nav__link> Installing Proxmox as a VM in FreeNAS </a> </li> <li class=md-nav__item> <a href=#import-a-cloudimg class=md-nav__link> Import a cloudimg </a> </li> <li class=md-nav__item> <a href=#custom-cloud-init-userdata class=md-nav__link> Custom cloud init userdata </a> </li> <li class=md-nav__item> <a href=#remove-all-containers class=md-nav__link> Remove all containers </a> </li> <li class=md-nav__item> <a href=#deploy-fedora-coreos-template class=md-nav__link> Deploy fedora coreos template </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=proxmox>Proxmox<a class=headerlink href=#proxmox title="Permanent link">&para;</a></h1> <p>I run Proxmox VE 7 in a 3 node cluster. Each node has 2x 2TB disk in ZFS RAID 1 (mirror). Each node also has access to NFS via my TrueNAS for shared storage. I've found running Ceph at home to be more trouble that its worth.</p> <h3 id=install-checklist>Install checklist<a class=headerlink href=#install-checklist title="Permanent link">&para;</a></h3> <p>From Proxmox VE 7 the install is straightforward, just choose your settings and go.</p> <p>When prompted for the hostname, use a FQDN.</p> <div class=codehilite><pre><span></span><code># yes
mynode.mydomain.com

# no
mynode
</code></pre></div> <h3 id=post-install-checklist>Post-install checklist<a class=headerlink href=#post-install-checklist title="Permanent link">&para;</a></h3> <p>This checklist is automated with my <a href=https://github.com/Ramblurr/home-ops/blob/main/ansible/roles/local/rmblr-proxmox-setup/tasks/main.yml><code>rmblr-proxmox-setup</code> role</a> (it might be more up to date than this list!).</p> <ul> <li>Install pve-no-subscription repo</li> <li>Configure the network interfaces</li> <li>Enable backports</li> <li>Remove pve-enterprise repo</li> <li>Disable IPV6</li> <li>Install my admin tools</li> <li>Install acme plugin and cloudflare DNS configuration</li> <li>Install borg+borgmatic and configure backups with Healthchecks</li> </ul> <h3 id=configuring-cluster>Configuring Cluster<a class=headerlink href=#configuring-cluster title="Permanent link">&para;</a></h3> <ol> <li>Install Proxmox VE on three nodes, use ZFS as the fs.</li> <li>Run the bootstrap ansible role</li> <li>From one node create the cluster</li> <li>Join the other nodes to the cluster</li> <li>Run the bootstrap ansible role again, because the joined nodes lose their ACME config, this re-adds it so you have valid certs</li> </ol> <h3 id=replicating-vms>Replicating VMs<a class=headerlink href=#replicating-vms title="Permanent link">&para;</a></h3> <p>From the <em>Datacenter</em> menu, go to <em>Replication</em> and add manual replication settings for each vm</p> <h3 id=replacing-a-zfs-boot-disk>Replacing a ZFS Boot Disk<a class=headerlink href=#replacing-a-zfs-boot-disk title="Permanent link">&para;</a></h3> <p>You might need to replace a proxmox boot disk that is in the ZFS pool.</p> <p>You should note that the Proxmox partition convention is:</p> <div class=codehilite><pre><span></span><code>Partition 1 = BIOS Boot
Partition 2 = EFI Boot
Partition 3 = ZFS
</code></pre></div> <p>This is the replacement procedure</p> <p>Given <code>/dev/sda</code> and <code>/dev/sdb</code>. <code>/dev/sdb</code> is the disk you want to replace.</p> <p>Pull your <code>/dev/sdb</code> from the chassis. Insert your new disk.</p> <p>Now <code>/dev/sdb</code> is a fresh disk that needs to join the pool</p> <p>Copy the partition table from <code>/dev/sda</code> to <code>/dev/sdb</code> and initialize new GUIDS for the partitions.</p> <div class=highlight><pre><span></span><code><span class=c1># WARNING the order of these flags is very important. If not careful you&#39;ll wipe your good drive.</span>
sgdisk<span class=w> </span>/dev/sda<span class=w> </span>-R<span class=w> </span>/dev/sdb
sgdisk<span class=w> </span>-G<span class=w> </span>/dev/sdb
</code></pre></div> <p>Next you should replace the bad disk in the ZFS pool. Get the id of the old disk using <code>zpool status</code> it should be marked as offline.</p> <div class=highlight><pre><span></span><code><span class=c1># Important, use partition 3!</span>
zpool<span class=w> </span>replace<span class=w> </span>-f<span class=w> </span>rpool<span class=w> </span>&lt;OLD<span class=w> </span>DISK&gt;<span class=w> </span>/dev/disk/by-id/sdb-part3
</code></pre></div> <p>Now ZFS will start resilvering. You can check the status of the resilver process with:</p> <div class=highlight><pre><span></span><code>zpool<span class=w> </span>status<span class=w> </span>-v<span class=w> </span>rpool
</code></pre></div> <p>After resilvering is complete, we need to install the boot environment on the EFI partition (partition # 2).</p> <div class=highlight><pre><span></span><code>proxmox-boot-tool<span class=w> </span>format<span class=w> </span>/dev/sdb2
proxmox-boot-tool<span class=w> </span>init<span class=w> </span>/dev/sdb2
proxmox-boot-tool<span class=w> </span>refresh
</code></pre></div> <p>This refreshes the boot environments on all EFI/BIOS boot partitions in the system. All disks are now bootable.</p> <h3 id=tailscale-in-a-container>Tailscale in a container:<a class=headerlink href=#tailscale-in-a-container title="Permanent link">&para;</a></h3> <p>Add </p> <p>lxc.cgroup.devices.allow: c 10:200 rwm lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file</p> <h3 id=setting-up-nfs-share>Setting up NFS Share<a class=headerlink href=#setting-up-nfs-share title="Permanent link">&para;</a></h3> <p>Use an NFS share for storing snippets, isos, etc</p> <ol> <li>Create dataset in freenas</li> <li>Create NFS share in freenas Add authorized IPs</li> <li>Create nfs user with dataset as home dir Set wheel as the primary group for the user Disable password</li> <li> <p>Edit the nfs share MapallUser -&gt; nfs user</p> </li> <li> <p>Storage &gt; Poosl &gt; NFS Dataset &gt; Edit Perms</p> <p>Owner: nfs user Group: Wheel Remove other permissions 6. In proxmox: Datacenter &gt; Storage &gt; Add NFS</p> </li> </ol> <p>source: <a href="https://www.youtube.com/watch?v=zeOe26fw7lo">https://www.youtube.com/watch?v=zeOe26fw7lo</a></p> <h3 id=multiple-vlans-with-single-nic>Multiple VLANs with Single NIC<a class=headerlink href=#multiple-vlans-with-single-nic title="Permanent link">&para;</a></h3> <p>Goals:</p> <ul> <li>proxmox web ui and ssh port is on vlan 10</li> <li>VMs and LXC containers assigned addreses on vlan 20</li> </ul> <p>Edit <code>/etc/network/interfaces</code></p> <div class=highlight><pre><span></span><code>auto lo
iface lo inet loopback

auto eno1
iface eno1 inet static
        address  0.0.0.0
        netmask  0.0.0.0

auto eno1.10
iface eno1.1 inet static
        address  0.0.0.0
        netmask  0.0.0.0

auto eno1.20
iface eno1.2 inet static
        address  0.0.0.0
        netmask  0.0.0.0

auto vmbr10
iface vmbr10 inet static
    address 10.8.10.10/24
    gateway 10.8.10.1
        bridge_ports eno1.10
        bridge_stp off
        bridge_fd 0

auto vmbr20
iface vmbr20 inet static
        address  10.8.20.5/24
        bridge_ports eno1.20
        bridge_stp off
        bridge_fd 0
</code></pre></div> <h3 id=installing-proxmox-as-a-vm-in-freenas>Installing Proxmox as a VM in FreeNAS<a class=headerlink href=#installing-proxmox-as-a-vm-in-freenas title="Permanent link">&para;</a></h3> <p>When you create the proxmox virtual machine and boot it the boot process will fail after obtaining a dhcp lease</p> <div class=highlight><pre><span></span><code>Starting a root shell on tty3
\nInstallation aborted - unable to continue 
</code></pre></div> <p>To fix this, use the provided shell to <div class=highlight><pre><span></span><code>chmod 1777 /tmp   
apt update
apt upgrade
Xorg -configure   
mv /xorg.conf.new /etc/X11/xorg.conf
vim /etc/X11/xorg.conf
# change the Screen Driver to &quot;fbdev&quot;
startx
</code></pre></div></p> <p>Then the installer will start. Install. Then X will exit. Power off the VM. Remove the cdrom device.</p> <h3 id=import-a-cloudimg>Import a cloudimg<a class=headerlink href=#import-a-cloudimg title="Permanent link">&para;</a></h3> <p>This has been wrapped in the ansible role <code>proxmox-template</code>.</p> <div class=highlight><pre><span></span><code>wget https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img
qm create 101 --memory 1024 --net0 virtio,bridge=vmbr20
qm importdisk 101 ./focal-server-cloudimg-amd64.img local-zfs
qm set 101 --scsihw virtio-scsi-pci --scsi0 local-zfs:vm-101-disk-0
qm set 101 --ide2 local-zfs:cloudinit
qm set 101 --boot c --bootdisk scsi0
qm set 101 --serial0 socket --vga serial0
qm set 101 --cipassword test --ciuser ubuntu
qm set 101 --ipconfig0 ip=dhcp
qm set 101 -agent 1

qm template 101

qm clone 101 201 --name dagon 
qm set 201 --memory 8192
qm set 201 -agent 1
qm set 201 --ipconfig0 ip=dhcp
qm set 201 --net0 virtio,bridge=vmbr0,tag=10,firewall=1
qm set 201 --net1 virtio,bridge=vmbr0,tag=20,firewall=1
qm set 201 --cicustom &quot;user=snippets:snippets/user-data&quot;
qm resize 201 scsi0 20G
cat &lt;&lt; EOF &gt; /etc/pve/firewall/201.fw
[OPTIONS]
enable: 1
[RULES]
GROUP allowssh
EOF


qm clone 101 202 --name hydra
qm set 202 --memory 8192
qm set 202 -agent 1
qm set 202 --ipconfig0 ip=dhcp
qm set 202 --net0 virtio,bridge=vmbr0,tag=10
qm set 202 --cicustom &quot;user=snippets:snippets/user-data&quot;
qm resize 202 scsi0 20G

qm clone 101 203 --name deepone
qm set 203 --memory 8192
qm set 203 -agent 1
qm set 203 --ipconfig0 ip=dhcp
qm set 203 --net0 virtio,bridge=vmbr0,tag=10
qm set 203 --cicustom &quot;user=snippets:snippets/user-data&quot;
qm resize 203 scsi0 20G


qm set 201 --sshkey ~/casey.pub 
</code></pre></div> <p><a href=https://pve.proxmox.com/wiki/Cloud-Init_Support>https://pve.proxmox.com/wiki/Cloud-Init_Support</a></p> <h3 id=custom-cloud-init-userdata>Custom cloud init userdata<a class=headerlink href=#custom-cloud-init-userdata title="Permanent link">&para;</a></h3> <ol> <li>Go to Storage View -&gt; Storage -&gt; Add -&gt; Directory</li> <li>Give it an ID such as snippets, and specify any path on your host such as /srv/snippets</li> <li>Under Content choose Snippets and de-select Disk image</li> <li>Upload (scp/rsync/whatever) your user-data, meta-data, network-config files to your proxmox server in /srv/snippets/snippets/</li> </ol> <div class=highlight><pre><span></span><code>qm set XXX --cicustom &quot;user=snippets:snippets/user-data&quot;

OR 

qm set XXX --cicustom &quot;user=snippets:snippets/user-data,network=snippets:snippets/network-config,meta=snippets:snippets/meta-data&quot;

qm cloudinit dump 204 user
</code></pre></div> <p>If you following the "Import a cloudimg" above, the vm should already have a cloudinit drive.</p> <p><a href=https://gist.github.com/aw/ce460c2100163c38734a83e09ac0439a>https://gist.github.com/aw/ce460c2100163c38734a83e09ac0439a</a></p> <h3 id=remove-all-containers>Remove all containers<a class=headerlink href=#remove-all-containers title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=k>for</span><span class=w> </span><span class=nv>i</span><span class=w> </span><span class=nv>in</span><span class=w> </span>$<span class=ss>(</span><span class=nv>pct</span><span class=w> </span><span class=nv>list</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nv>awk</span><span class=w> </span><span class=s1>&#39;/\d/{print $1}&#39;</span><span class=ss>)</span><span class=c1>; do pct destroy &quot;$i&quot; -purge ; done</span>
</code></pre></div> <h2 id=deploy-fedora-coreos-template>Deploy fedora coreos template<a class=headerlink href=#deploy-fedora-coreos-template title="Permanent link">&para;</a></h2> <p>fedora core os on proxmox</p> <p>on workstation: <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>workspace/
coreos-installer<span class=w> </span>download<span class=w> </span>-s<span class=w> </span>stable<span class=w> </span>-p<span class=w> </span>qemu<span class=w> </span>-f<span class=w> </span>qcow2.xz<span class=w> </span>--decompress<span class=w> </span>-C<span class=w> </span>.
scp<span class=w> </span>fedora-coreos-34.20210904.3.0-qemu.x86_64.qcow2<span class=w> </span>PROXMOX_HOST:
</code></pre></div></p> <p>on proxmox host: 1. (in ui) create a vm and remove the default disks 2. import the image</p> <p><div class=highlight><pre><span></span><code>qm<span class=w> </span>importdisk<span class=w> </span><span class=m>9996</span><span class=w> </span>./fedora-coreos-34.20210904.3.0-qemu.x86_64.qcow2<span class=w> </span>local-zfs
qm<span class=w> </span><span class=nb>set</span><span class=w> </span><span class=m>9996</span><span class=w> </span>--scsi0<span class=w> </span>local-zfs:vm-9996-disk-1
qm<span class=w> </span><span class=nb>set</span><span class=w> </span><span class=m>9996</span><span class=w> </span>--boot<span class=w> </span><span class=nv>order</span><span class=o>=</span>scsi0
qm<span class=w> </span>template<span class=w> </span><span class=m>9996</span>
</code></pre></div> 3. create vms from the template, then for each one:</p> <div class=highlight><pre><span></span><code>vi<span class=w> </span>/etc/pve/qemu-server/VMID.conf
add:
<span class=w>  </span>args:<span class=w> </span>-fw_cfg<span class=w> </span><span class=nv>name</span><span class=o>=</span>opt/com.coreos/config,file<span class=o>=</span>/mnt/pve/mali/snippets/server-1.ign
</code></pre></div> <ol> <li>make sure the snippet file exists, and edit the file for the corresponding server+client number</li> </ol> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "search.share", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.4b2c34cd.min.js></script> </body> </html>