<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../proxmox/ rel=prev><link href=../../RaspberryPi/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.12"><title>Unifi USG LTE Failover - Ramblurr's Notes</title><link rel=stylesheet href=../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CIMB+Plex+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"IMB Plex Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#unifi-usg-lte-failover class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Ramblurr's Notes" class="md-header__button md-logo" aria-label="Ramblurr's Notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Ramblurr's Notes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Unifi USG LTE Failover </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Ramblurr's Notes" class="md-nav__button md-logo" aria-label="Ramblurr's Notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Ramblurr's Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Ramblurr's Notes </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../ >HomeOps</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> HomeOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../proxmox/ class=md-nav__link> Proxmox </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Unifi USG LTE Failover <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Unifi USG LTE Failover </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#hardware class=md-nav__link> Hardware </a> </li> <li class=md-nav__item> <a href=#software class=md-nav__link> Software </a> </li> <li class=md-nav__item> <a href=#address-space class=md-nav__link> Address Space </a> </li> <li class=md-nav__item> <a href=#pre-setup-test-lte-dongle-is-working class=md-nav__link> Pre-setup - Test LTE dongle is working </a> </li> <li class=md-nav__item> <a href=#setup-of-pi class=md-nav__link> Setup of PI </a> </li> <li class=md-nav__item> <a href=#unifi-usg-wan-failover-configuration class=md-nav__link> Unifi USG WAN failover configuration </a> </li> <li class=md-nav__item> <a href=#resources class=md-nav__link> Resources </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../RaspberryPi/ class=md-nav__link> RaspberryPi </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#hardware class=md-nav__link> Hardware </a> </li> <li class=md-nav__item> <a href=#software class=md-nav__link> Software </a> </li> <li class=md-nav__item> <a href=#address-space class=md-nav__link> Address Space </a> </li> <li class=md-nav__item> <a href=#pre-setup-test-lte-dongle-is-working class=md-nav__link> Pre-setup - Test LTE dongle is working </a> </li> <li class=md-nav__item> <a href=#setup-of-pi class=md-nav__link> Setup of PI </a> </li> <li class=md-nav__item> <a href=#unifi-usg-wan-failover-configuration class=md-nav__link> Unifi USG WAN failover configuration </a> </li> <li class=md-nav__item> <a href=#resources class=md-nav__link> Resources </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=unifi-usg-lte-failover>Unifi USG LTE Failover<a class=headerlink href=#unifi-usg-lte-failover title="Permanent link">&para;</a></h1> <p>This document describes how to setup WAN failover for a Unifi USG to an LTE network accesed via a 4G USB dongle plugged in to a Raspberry Pi.</p> <p>Most of this guide is dedicated to configuring a Raspberry PI to act as a mini-router.</p> <p>A few things of note:</p> <ul> <li> <p>Despite using a LTE dongle, you won't get LTE speeds unless you use a PI with a gigabit NIC, which in October 2020 is only the RPI 4. <a href=https://www.jeffgeerling.com/blogs/jeff-geerling/getting-gigabit-networking>more info</a></p> </li> <li> <p>The PI and dongle are configured to NAT. This is ugly, but works for my use case. In a failover scenario, I'm ok with external access being cut.</p> </li> </ul> <p>In theory it is possible to switch the dongle into modem mode <a href=https://support.aa.net.uk/FireBrick_2700_with_4G_ZTE_MF823#Changing_the_ZTE_MF823_to_.27serial_modem.27_mode>[0]</a>, but I haven't tried this. You'd need to alter this config anyways to remove the NAT on the PI.</p> <h2 id=hardware>Hardware<a class=headerlink href=#hardware title="Permanent link">&para;</a></h2> <ul> <li>Unifi USG</li> <li>An extra switch (unmanaged, 100mb or 1gbit depending on if your PI supports gbit or not)</li> <li>Raspberry Pi</li> <li>ZTE MF823 LTE USB Dongle</li> </ul> <h2 id=software>Software<a class=headerlink href=#software title="Permanent link">&para;</a></h2> <ul> <li>Unifi Controller</li> <li>TinyCoreLinux PiCore <a href=http://tinycorelinux.net/ports.html>download</a> (v11 at time of writing)</li> </ul> <h2 id=address-space>Address Space<a class=headerlink href=#address-space title="Permanent link">&para;</a></h2> <ul> <li><code>192.168.0.1/24</code> for <code>usb0</code> - this is the default subnet on the MF823, your home LAN musn't overlap with this.</li> <li><s><code>192.168.73.1/24</code> for <code>usb0</code> - we will change the MF823 to use this subnet</s> editing the dongle's settings doesn't stick across reboots</li> <li><code>192.168.12.1/24</code> for <code>eth0</code> - for USG&lt;-&gt;PI</li> </ul> <h2 id=pre-setup-test-lte-dongle-is-working>Pre-setup - Test LTE dongle is working<a class=headerlink href=#pre-setup-test-lte-dongle-is-working title="Permanent link">&para;</a></h2> <p>Flash PiCore onto SD card</p> <p>Boot PiCore, plug into ethernet</p> <div class=highlight><pre><span></span><code>sudo /sbin/udhcp -v -i eth0 -x hostname:wan2 -p /var/run/udhcp.eth0.pid
ping 1.1.1.1
</code></pre></div> <p>Insert dongle .. wait for it to settle ~60 seconds</p> <p>Test</p> <div class=highlight><pre><span></span><code>lsusb
</code></pre></div> <p>While the dongle is booting it will show a red light and you will see <div class=highlight><pre><span></span><code>ID 19d2:1225
</code></pre></div></p> <p>After it is ready the light will turn green and it will change to <div class=highlight><pre><span></span><code>ID 19d2:1405
</code></pre></div></p> <p>Load the kernel module</p> <div class=highlight><pre><span></span><code>modprobe cdc_ether
ifconfig -a
</code></pre></div> <p>You should see <code>usb0</code></p> <p>Setup usb0</p> <div class=highlight><pre><span></span><code>sudo /sbin/udhcp -v -i usb0 -x hostname:wan2 -p /var/run/udhcp.usb0.pid
ping 192.168.0.1
</code></pre></div> <p>Use Socks proxy from your workstation to access MFG823's webui</p> <div class=highlight><pre><span></span><code># on workstation on same LAN as the pi
ssh -D 1337 tc@192.168.1.146
</code></pre></div> <p>(192.168.1.146 was the ip on my local lan the pi got for eth0)</p> <p>Use browser's socks settings to set socks 5 proxy 192.168.1.146 port 1337</p> <p>Browse to 192.168.0.1 in browser, confirm the web ui is loading. If you have a sim card in, you should see LTE network connection status.</p> <h2 id=setup-of-pi>Setup of PI<a class=headerlink href=#setup-of-pi title="Permanent link">&para;</a></h2> <p>Ok its working. Time to setup the router on the pi.</p> <p>First, lets setup wifi on the pi. <code>eth0</code> will become the LAN port for the pi router, but we need a headless/oob management channel, this will be over wifi.</p> <p>SSH into the pi</p> <p>Add ssh config and passwd to persistent config</p> <div class=highlight><pre><span></span><code>mkdir ~/.ssh
vi ~/.ssh/authorized_keys
# paste your ssh key
sudo echo &#39;/usr/local/etc/ssh&#39; &gt;&gt; /opt/.filetool.lst 
sudo echo &#39;/etc/shadow&#39; &gt;&gt; /opt/.filetool.lst
sudo echo &#39;/home/tc/.ssh/&#39; &gt;&gt; /opt/.filetool.lst
filetool.sh -b
</code></pre></div> <p>Download the wifi extension and reboot to load the module <div class=highlight><pre><span></span><code>tce-load -wi firmware-rpi-wifi.tcz
tce-load -wi wifi.tcz
sudo reboot
</code></pre></div></p> <p>SSH again (using the key this time) and check for <code>wlan0</code></p> <div class=highlight><pre><span></span><code>iwconfig
</code></pre></div> <p>Connect to your AP</p> <div class=highlight><pre><span></span><code>sudo /usr/local/bin/wifi.sh 
</code></pre></div> <p>Check <code>wlan0</code> connection</p> <div class=highlight><pre><span></span><code>ifconfig wlan0
</code></pre></div> <p>Configure auto wlan connect on system boot</p> <div class=highlight><pre><span></span><code>sudo echo &#39;/usr/local/bin/wifi.sh -a 2&gt;&amp;1 &gt; /tmp/wifi.log&#39; &gt;&gt; /opt/bootlocal.sh
filetool.sh -b
</code></pre></div> <p>Reboot to test wlan0 auto config <div class=highlight><pre><span></span><code>sudo reboot
</code></pre></div></p> <p>Quickly SSH in over the <code>eth0</code> interface, get the <code>wlan0</code> ip address and then ssh back in over wifi.</p> <p>From here on out I assume you are managing the pi over <code>wlan0</code>, as we will be making changes to <code>eth0</code>.</p> <p>NOTE: The following section is included, but does not seem to actually work. Everytime the dongle is rebooted, the settings are reverted.</p> <blockquote> <p>Next, let's change the subnet used by the ZTE MG 823 router so it doesn't use the common <code>192.168.0.1</code> subnet.</p> <p>Ssh into the Pi, then telnet into the router</p> <div class=highlight><pre><span></span><code>telnet 192.168.0.1
# user: root
# password: zte9x15
</code></pre></div> <p>Edit the file at <code>/usr/zte/zte_conf/config/userseting_nvconfig.txt</code></p> <p>Change the values:</p> <div class=highlight><pre><span></span><code>dhcpStart
dhcpEnd
lan_ipaddr
lan_ipaddr_for_current
</code></pre></div> <p>I assume in the rest of this that you are using the subnet <code>192.168.73.0/24</code></p> </blockquote> <p>Actually, we continue with <code>192.168.0.1</code>, since the above is not sticking.</p> <p>Create <code>/opt/eth0.sh</code></p> <div class=highlight><pre><span></span><code>#!/bin/sh

sleep .5

sleep 1
if [ -f /var/run/udhcpc.eth0.pid ]; then
kill `cat /var/run/udhcpc.eth0.pid`
sleep 0.1
fi

ifconfig eth0 192.168.12.1 netmask 255.255.255.0 broadcast 192.168.12.255 up

sleep .1
sudo udhcpd /etc/eth0_udhcpd.conf &amp;
</code></pre></div> <p>Make it executable</p> <div class=highlight><pre><span></span><code>chmod 775 /etc/eth0.sh
</code></pre></div> <p>Create DHCP config for <code>eth0</code> in <code>/etc/eth0_udhcpd.conf</code></p> <div class=highlight><pre><span></span><code>start 192.168.12.100
end 192.168.12.200
interface eth0
option subnet 255.255.255.0
option router 192.168.12.1
option lease 43200
option dns 192.168.12.1
option domain wanfailover
</code></pre></div> <p>Start and test dhcp server. You should see it listening on port udp 67.</p> <div class=highlight><pre><span></span><code>sudo udhcpd /etc/eth0_udhcpd.conf
ps -ef | grep udhcpd
sudo netstat -anp | grep udhcpd
</code></pre></div> <p>Create init script to manage <code>usb0</code> in <code>/etc/init.d/dhcp-usb0.sh</code></p> <p>Get file contets here <a href=./dhcp-usb0.sh><code>dhcp-usb0.sh</code></a></p> <p>Make it executable</p> <div class=highlight><pre><span></span><code>chmod 766 /etc/init.d/dhcp-usb0.sh
</code></pre></div> <p>Create udev rule to auto connect to the <code>usb0</code> network in <code>/etc/udev/rules.d/15-zte-mf823.rules</code></p> <div class=highlight><pre><span></span><code>SUBSYSTEM==&quot;usb&quot;, ATTR{idProduct}==&quot;1405&quot;, ATTR{idVendor}==&quot;19d2&quot;, RUN+=&quot;/etc/init.d/dhcp-usb0.sh restart&quot;
</code></pre></div> <p>Reload udev rules</p> <div class=highlight><pre><span></span><code>sudo udevadm control --reload-rules 
</code></pre></div> <p>Unplug USB device, wait a few seconds, plug it back in. Check that <code>usb0</code> has an ip in the <code>192.168.0.0/24</code> subnet.</p> <p>Persist the config</p> <div class=highlight><pre><span></span><code>sudo echo &#39;/opt/eth0.sh&#39; &gt;&gt; /opt/.filetool.lst
sudo echo &#39;/etc/eth0_udhcpd.conf&#39; &gt;&gt; /opt/.filetool.lst
sudo echo &#39;/etc/init.d/dhcp-usb0.sh&#39; &gt;&gt; /opt/.filetool.lst
sudo echo &#39;/etc/udev/rules.d/15-zte-mf823.rules&#39; &gt;&gt; /opt/.filetool.lst
sudo echo &#39;/opt/eth0.sh &amp;&#39; &gt;&gt; /opt/bootlocal.sh
filetool.sh -b 
</code></pre></div> <p>Reboot to test. You should see <code>eth0</code> with an ip address of <code>192.168.12.1</code>, and <code>usb0</code> should be configured.</p> <p>Enable ipv4 forwarding</p> <div class=highlight><pre><span></span><code>sudo sysctl -w net.ipv4.ip_forward=1
sudo echo &#39;sysctl -w net.ipv4.ip_forward=1&#39; &gt;&gt; /opt/bootlocal.sh
filetool.sh -b
</code></pre></div> <p>Install dnsmasq and iptables</p> <div class=highlight><pre><span></span><code>tce-load -wi dnsmasq
tce-load -wi iptables
</code></pre></div> <p>Enable NAT</p> <div class=highlight><pre><span></span><code>sudo iptables -t nat -A POSTROUTING -o usb0 -j MASQUERADE
</code></pre></div> <p>Make it persistent</p> <div class=highlight><pre><span></span><code>sudo echo &#39;iptables -t nat -A POSTROUTING -o usb0 -j MASQUERADE&#39; &gt;&gt; /opt/bootlocal.sh
sudo echo &#39;dnsmasq&#39; &gt;&gt; /opt/bootlocal.sh
</code></pre></div> <p>Finally, add a little script to remove the wifi default gateway. Without this, the wifi script will take over the default gateway. The actual default gateway is set by our usb udev script.</p> <p><code>/opt/fix-gw.sh</code></p> <div class=highlight><pre><span></span><code>#!/bin/sh

gw=$(route -n|grep &quot;UG&quot;|grep -v &quot;UGH&quot;|cut -f 10 -d &quot; &quot;)

if [ ! -z &quot;$gw&quot; ]; then
  route del default gw &quot;$gw&quot;
fi
</code></pre></div> <p>Save it</p> <div class=highlight><pre><span></span><code>chmod 777 /opt/fix-gw.sh
sudo echo &#39;/opt/fix-gw.sh&#39; &gt;&gt; /opt/.filetool.lst
sudo echo &#39;/opt/fix-gw.sh&#39; &gt;&gt; /opt/bootlocal.sh
filetool.sh -b
</code></pre></div> <p>Do a final reboot. Connect your pi to an empty switch, connect your laptop to the switch. You should have internet via the LTE dongle, verify with</p> <div class=highlight><pre><span></span><code>curl https://iconfig.co/json | jq
</code></pre></div> <p>You should see your LTE provider's info.</p> <h2 id=unifi-usg-wan-failover-configuration>Unifi USG WAN failover configuration<a class=headerlink href=#unifi-usg-wan-failover-configuration title="Permanent link">&para;</a></h2> <p>This is a small cluster-f*** depending on your Controller version and whether you have the old or new settings interface. In short, any docs you read about setting the "Port Remapping" feature are out of date since at least 2019.</p> <p>You must not be using the WAN2 port for LAN traffic.</p> <p>Assuming the old, non beta (as of Oct 2020) settings UI you can follow what is below.</p> <p>Are you from the future where the new beta UI is no longer beta, and the old UI is gone? Good luck.</p> <ol> <li> <p>Create a WAN2 network</p> <p>Settings -&gt; Networks -&gt; [ + Create New Network ] Purpose: WAN Network Group: WAN2 Load Balancing: dropdown, choose "Failover Only" to use the WAN2 port only if WAN has failed</p> </li> <li> <p>Assign the USG's port to the WAN2 network</p> <p>Devices -&gt; USG -&gt; Ports tab -&gt; [ Configure interfaces ]</p> <p>Port WAN2/LAN2 Network: WAN2</p> <p>Apply</p> </li> </ol> <p>Wait for the USG to re-provision.</p> <p>Test it by sshing into the USG and execute:</p> <div class=highlight><pre><span></span><code>ip addr # check eth2
show load-balance status
show load-balance watchdog
</code></pre></div> <p>That's it. Unplug your WAN1, watch it failover to WAN2. Plug WAN1 back in and see WAN2 recover.</p> <p>In case you're wondering: you do get email alerts and alerts in the Controller UI whenever a WAN transition happens.</p> <h2 id=resources>Resources<a class=headerlink href=#resources title="Permanent link">&para;</a></h2> <ul> <li>hacking MF 823's UI - <a href=https://www.development-cycle.com/2017/04/27/zte-mf823-inside/ >https://www.development-cycle.com/2017/04/27/zte-mf823-inside/</a></li> <li>device info <a href=https://wiki.archlinux.org/index.php/ZTE_MF_823_(Megafon_M100-3)_4G_Modem>https://wiki.archlinux.org/index.php/ZTE_MF_823_(Megafon_M100-3)_4G_Modem</a></li> <li>tinycore ip router setup <a href=https://iotbytes.wordpress.com/configure-microcore-tiny-linux-as-router/ >https://iotbytes.wordpress.com/configure-microcore-tiny-linux-as-router/</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "search.share", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.4b2c34cd.min.js></script> </body> </html>